---
- name: Prepare Talos GPU image on BSU volume
  hosts: all
  become: true
  vars:
    talos_version: "{{ lookup('env', 'TALOS_VERSION') | default('v1.11.5', true) }}"
    image_type: "{{ lookup('env', 'IMAGE_TYPE') | default('universal', true) }}"
    talos_dir: /opt/talos
    talos_xz: "{{ talos_dir }}/nocloud-amd64.raw.xz"
    talos_raw: "{{ talos_dir }}/nocloud-amd64.raw"
    target_device: /dev/xvdf
    # Extensions NVIDIA selon le type d'image
    nvidia_extensions_universal:
      - siderolabs/nvidia-open-gpu-kernel-modules-production
      - siderolabs/nvidia-container-toolkit-production
      - siderolabs/nvidia-fabricmanager-production
    nvidia_extensions_simple:
      - siderolabs/nvidia-open-gpu-kernel-modules-production
      - siderolabs/nvidia-container-toolkit-production

  tasks:
    - name: Ensure work dir
      ansible.builtin.file:
        path: "{{ talos_dir }}"
        state: directory
        mode: "0755"

    - name: Set extensions based on image type
      ansible.builtin.set_fact:
        extensions: "{{ nvidia_extensions_universal if image_type == 'universal' else nvidia_extensions_simple }}"

    - name: Create schematic YAML for GPU image
      ansible.builtin.copy:
        dest: "{{ talos_dir }}/schematic-gpu.yaml"
        mode: "0644"
        content: |
          customization:
            systemExtensions:
              officialExtensions:
          {% for ext in extensions %}
                - {{ ext }}
          {% endfor %}

    - name: Display schematic content
      ansible.builtin.debug:
        msg: "Schematic créé pour type: {{ image_type }} avec {{ extensions | length }} extensions"

    - name: Read schematic file content
      ansible.builtin.slurp:
        src: "{{ talos_dir }}/schematic-gpu.yaml"
      register: schematic_file

    - name: Submit schematic to Talos Image Factory
      ansible.builtin.uri:
        url: https://factory.talos.dev/schematics
        method: POST
        body: "{{ schematic_file.content | b64decode }}"
        headers:
          Content-Type: application/yaml
        return_content: true
        status_code: 201
      register: schematic_response

    - name: Extract schematic ID from response
      ansible.builtin.set_fact:
        schematic_id: "{{ schematic_response.json.id }}"

    - name: Display schematic ID
      ansible.builtin.debug:
        msg: "Schematic ID: {{ schematic_id }}"

    - name: Download Talos GPU image from Image Factory
      ansible.builtin.get_url:
        url: "https://factory.talos.dev/image/{{ schematic_id }}/{{ talos_version }}/nocloud-amd64.raw.xz"
        dest: "{{ talos_xz }}"
        mode: "0644"
        force: true
        timeout: 600

    - name: Install required packages
      ansible.builtin.package:
        name:
          - xz-utils
          - parted
        state: present

    - name: Decompress xz to raw (keeps .xz)
      ansible.builtin.command:
        cmd: "xz -d -k {{ talos_xz }}"
        creates: "{{ talos_raw }}"

    - name: Zero the target device partition table (safety)
      ansible.builtin.command:
        cmd: "sgdisk --zap-all {{ target_device }}"
      changed_when: false
      failed_when: false
      register: zap_result
      ignore_errors: true

    - name: Write raw image to BSU volume
      ansible.builtin.command:
        cmd: "dd if={{ talos_raw }} of={{ target_device }} bs=8M oflag=direct status=progress"

    - name: Flush caches (sync)
      ansible.builtin.command:
        cmd: "sync"

    - name: Udev settle
      ansible.builtin.command:
        cmd: "udevadm settle"
      changed_when: false
      failed_when: false

    - name: Show resulting partition table (debug)
      ansible.builtin.command:
        cmd: "parted -s {{ target_device }} print"
      register: parted_print
      changed_when: false

    - name: Debug parted output
      ansible.builtin.debug:
        var: parted_print.stdout
